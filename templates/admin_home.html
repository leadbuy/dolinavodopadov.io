{% extends "admin_base.html" %}

{% block extra_head %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const saveButtons = document.querySelectorAll('.save-btn');
        const textareas = document.querySelectorAll('textarea');
        
        // –°—á–µ—Ç—á–∏–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤
        textareas.forEach(textarea => {
            const counter = textarea.parentElement.querySelector('.char-counter');
            if (counter) {
                textarea.addEventListener('input', function() {
                    counter.textContent = `${this.value.length}/1000`;
                    const saveBtn = this.closest('.admin-section').querySelector('.save-btn');
                    if (saveBtn) saveBtn.disabled = false;
                });
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        saveButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const section = this.dataset.section;
                const fields = {};
                
                const form = this.closest('.admin-section');
                const inputs = form.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    if (input.name) {
                        fields[input.name] = input.value;
                    }
                });
                
                saveContent(section, fields, this);
            });
        });
        
        // –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        if (changePasswordBtn) {
            changePasswordBtn.addEventListener('click', function() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showNotification('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                    return;
                }
                
                changePassword(currentPassword, newPassword, confirmPassword, this);
            });
        }
    });
    
    function saveContent(section, data, button) {
        const originalText = button.textContent;
        
        button.disabled = true;
        button.innerHTML = '<span class="loading"></span> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        
        fetch('/admin/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                section: section,
                fields: data
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                
                const status = button.parentElement.querySelector('.saved-status');
                if (status) {
                    status.classList.add('show');
                    setTimeout(() => status.classList.remove('show'), 3000);
                }
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + result.message, 'error');
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
    
    function changePassword(currentPassword, newPassword, confirmPassword, button) {
        const originalText = button.textContent;
        
        button.disabled = true;
        button.innerHTML = '<span class="loading"></span> –ú–µ–Ω—è–µ–º –ø–∞—Ä–æ–ª—å...';
        
        fetch('/admin/reset-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword,
                confirm_password: confirmPassword
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!', 'success');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + result.message, 'error');
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ —Å–ª–∞–π–¥–µ—Ä–∞
    function handleImageUpload(file) {
        if (!file) return;
        
        if (file.size > 16 * 1024 * 1024) {
            showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 16MB', 'error');
            return;
        }
        
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            showNotification('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞', 'error');
            return;
        }
        
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadBar = document.getElementById('uploadBar');
        uploadProgress.style.display = 'block';
        uploadBar.style.width = '0%';
        
        const formData = new FormData();
        formData.append('image', file);
        
        fetch('/admin/upload-image', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                uploadBar.style.width = '100%';
                showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!', 'success');
                
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + result.message, 'error');
                uploadProgress.style.display = 'none';
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
            uploadProgress.style.display = 'none';
        })
        .finally(() => {
            document.getElementById('imageUpload').value = '';
            
            if (uploadBar.style.width === '100%') {
                setTimeout(() => {
                    uploadProgress.style.display = 'none';
                }, 1000);
            }
        });
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += 5;
            uploadBar.style.width = progress + '%';
            if (progress >= 90) clearInterval(interval);
        }, 100);
    }

    function deleteImage(filename) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ "${filename}"?`)) {
            return;
        }
        
        showNotification('–£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...', 'success');
        
        fetch('/admin/delete-image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                filename: filename
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!', 'success');
                
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + result.message, 'error');
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        });
    }

    // Drag and drop –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    document.addEventListener('DOMContentLoaded', function() {
        const uploadArea = document.querySelector('.upload-area');
        const fileInput = document.getElementById('imageUpload');
        
        if (uploadArea && fileInput) {
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#667eea';
                uploadArea.style.backgroundColor = '#ebf8ff';
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#cbd5e0';
                uploadArea.style.backgroundColor = '#f8fafc';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#cbd5e0';
                uploadArea.style.backgroundColor = '#f8fafc';
                
                if (e.dataTransfer.files.length) {
                    handleImageUpload(e.dataTransfer.files[0]);
                }
            });
            
            uploadArea.addEventListener('click', function(e) {
                if (e.target.tagName !== 'BUTTON') {
                    fileInput.click();
                }
            });
        }
    });
</script>
{% endblock %}

{% block content %}
<!-- –†–∞–∑–¥–µ–ª –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<section class="admin-section">
    <div class="section-header">
        <h2>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h2>
        <div class="save-btn" data-section="hero">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        </div>
    </div>
    
    <div class="form-group">
        <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–∞–π—Ç–∞</label>
        <input type="text" id="title" name="title" 
               value="{{ page_data.hero.title if page_data.hero }}" 
               placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–∞–π—Ç–∞">
    </div>
    
    <div class="form-group">
        <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º</label>
        <textarea id="description" name="description" 
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∞–π—Ç–∞">{{ page_data.hero.description if page_data.hero }}</textarea>
        <div class="char-counter">0/1000</div>
    </div>
</section>

<!-- –†–∞–∑–¥–µ–ª "–û –Ω–∞—Å" -->
<section class="admin-section">
    <div class="section-header">
        <h2>–†–∞–∑–¥–µ–ª "–û –Ω–∞—Å"</h2>
        <div class="save-btn" data-section="about">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        </div>
    </div>
    
    <div class="form-group">
        <label for="paragraph1">–ü–µ—Ä–≤—ã–π –∞–±–∑–∞—Ü</label>
        <textarea id="paragraph1" name="paragraph1" 
                  placeholder="–ü–µ—Ä–≤—ã–π –∞–±–∑–∞—Ü —Ç–µ–∫—Å—Ç–∞">{{ page_data.about.paragraph1 if page_data.about }}</textarea>
        <div class="char-counter">0/1000</div>
    </div>
    
    <div class="form-group">
        <label for="paragraph2">–í—Ç–æ—Ä–æ–π –∞–±–∑–∞—Ü</label>
        <textarea id="paragraph2" name="paragraph2" 
                  placeholder="–í—Ç–æ—Ä–æ–π –∞–±–∑–∞—Ü —Ç–µ–∫—Å—Ç–∞">{{ page_data.about.paragraph2 if page_data.about }}</textarea>
        <div class="char-counter">0/1000</div>
    </div>
    
    <div class="form-group">
        <label for="paragraph3">–¢—Ä–µ—Ç–∏–π –∞–±–∑–∞—Ü</label>
        <textarea id="paragraph3" name="paragraph3" 
                  placeholder="–¢—Ä–µ—Ç–∏–π –∞–±–∑–∞—Ü —Ç–µ–∫—Å—Ç–∞">{{ page_data.about.paragraph3 if page_data.about }}</textarea>
        <div class="char-counter">0/1000</div>
    </div>
</section>

<!-- –†–∞–∑–¥–µ–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ —Å–ª–∞–π–¥–µ—Ä–∞ -->
<section class="admin-section">
    <div class="section-header">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ —Å–ª–∞–π–¥–µ—Ä–∞</h2>
        <div class="saved-status" style="display: flex; align-items: center; gap: 5px;">
            <span style="color: #48bb78;">‚úì</span>
            <span>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span>
        </div>
    </div>
    
    <div class="image-management">
        <div class="form-group">
            <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
            <div class="upload-area" style="border: 2px dashed #cbd5e0; border-radius: 8px; padding: 30px; text-align: center; background: #f8fafc; margin-bottom: 20px;">
                
                <p style="color: #4a5568; margin-bottom: 15px;">
                    –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞
                </p>
                <input type="file" id="imageUpload" accept=".jpg,.jpeg,.png,.gif,.webp" 
                    style="display: none;" onchange="handleImageUpload(this.files[0])">
                <button onclick="document.getElementById('imageUpload').click()" 
                        class="save-btn" style="background: #4299e1; margin: 0 auto;">
                    –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                </button>
                <div id="uploadProgress" style="display: none; margin-top: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
                        <div class="loading"></div>
                        <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <div style="width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; margin-top: 10px;">
                        <div id="uploadBar" style="width: 0%; height: 100%; background: #48bb78; border-radius: 2px; transition: width 0.3s;"></div>
                    </div>
                </div>
                <p style="font-size: 12px; color: #718096; margin-top: 15px;">
                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, JPEG, PNG, GIF, WEBP<br>
                    –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 16MB
                </p>
            </div>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
        <div class="form-group">
            <label>–¢–µ–∫—É—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–ª–∞–π–¥–µ—Ä–µ ({{ images_info|length }}):</label>
            <div class="current-images">
                {% if images_info %}
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; max-height: 400px; overflow-y: auto;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                            {% for image in images_info %}
                            <div class="image-card" style="background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0;">
                                <!-- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –∑–∞–º–µ–Ω—è–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π div –Ω–∞ img -->
                                <div style="height: 120px; position: relative; background: #f7fafc; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                    <img src="{{ url_for('static', filename=image.path) }}" 
                                        alt="{{ image.filename }}"
                                        style="width: 100%; height: 100%; object-fit: cover;"
                                        onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\'color:#718096; text-align:center; padding:20px\'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'">
                                    {% if loop.first %}
                                    <div style="position: absolute; top: 10px; right: 10px; background: #48bb78; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">
                                        –ê–∫—Ç–∏–≤–Ω–æ
                                    </div>
                                    {% endif %}
                                </div>
                                <div style="padding: 10px;">
                                    <div style="font-weight: 600; color: #2d3748; margin-bottom: 5px; font-size: 13px;">
                                        {{ image.filename }}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: #718096; margin-bottom: 10px;">
                                        <span>{{ (image.size / 1024)|round(1) }} KB</span>
                                        <span>‚Ññ {{ loop.index }}</span>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="deleteImage('{{ image.filename }}')" 
                                                class="delete-btn" 
                                                style="flex: 1; background: #fed7d7; color: #c53030; border: none; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                        <button onclick="alert('–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω—É–π—Ç–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ static/images/hero-section/')" 
                                                class="set-first-btn" 
                                                style="flex: 1; background: #e6fffa; color: #234e52; border: none; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 12px;"
                                                {% if loop.first %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
                                            {% if loop.first %}–ü–µ—Ä–≤—ã–π{% else %}–°–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–º{% endif %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <p style="margin-top: 10px; color: #48bb78; font-size: 14px;">
                        ‚úì –ù–∞–π–¥–µ–Ω–æ {{ images_info|length }} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                    </p>
                {% else %}
                    <div style="background: #fed7d7; padding: 30px; border-radius: 8px; text-align: center; border: 1px solid #fc8181;">
                        <i style="font-size: 48px; color: #c53030; margin-bottom: 15px; display: block;">üì∑</i>
                        <p style="color: #c53030; margin: 0; font-size: 16px;">
                            ‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!
                        </p>
                        <p style="color: #c53030; margin-top: 10px; font-size: 14px;">
                            –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é —Ñ–æ—Ä–º—ã –≤—ã—à–µ
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å -->
<section class="admin-section security-section">
    <div class="section-header">
        <h2><i>üîí</i> –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2>
    </div>
    
    <div class="password-form">
        <div class="form-group">
            <label for="currentPassword">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
            <input type="password" id="currentPassword" 
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å">
        </div>
        
        <div class="form-group">
            <label for="newPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
            <input type="password" id="newPassword" 
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
        </div>
        
        <div class="form-group">
            <label for="confirmPassword">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
            <input type="password" id="confirmPassword" 
                   placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
        </div>
        
        <button id="changePasswordBtn" class="save-btn">
            –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
        </button>
    </div>
</section>
{% endblock %}