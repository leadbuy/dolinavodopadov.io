{% extends "admin_base.html" %}

{% block extra_head %}
<script>
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è–º–∏
    let currentAttractionId = null;
    let currentAttractionImages = [];
    const MAX_FILE_SIZE = 16 * 1024 * 1024;

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π
    function loadAttractions() {
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π...');
        
        fetch('/admin/attractions', {
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
            console.log('–ó–∞–≥–æ–ª–æ–≤–∫–∏:', response.headers);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç JSON
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                // –ï—Å–ª–∏ –Ω–µ JSON, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                return response.text().then(text => {
                    console.error('–û—Ç–≤–µ—Ç –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:', text.substring(0, 200));
                    throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON: ' + response.status);
                });
            }
        })
        .then(data => {
            console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);
            if (data.success) {
                renderAttractionsList(data.attractions);
            } else {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ
            const container = document.getElementById('attractionsList');
            if (container) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e53e3e;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                        <p style="font-size: 16px; margin-bottom: 10px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π</p>
                        <p style="font-size: 14px; color: #718096;">${error.message}</p>
                        <button onclick="loadAttractions()" 
                                style="margin-top: 20px; padding: 8px 16px; background: #4299e1; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                        </button>
                    </div>
                `;
            }
        });
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π
    function renderAttractionsList(attractions) {
        const container = document.getElementById('attractionsList');
        
        if (!attractions || attractions.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #718096;">
                    <i style="font-size: 48px; display: block; margin-bottom: 15px;">üèûÔ∏è</i>
                    <p style="font-size: 16px;">–ù–µ—Ç –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π</p>
                    <p style="font-size: 14px; margin-top: 10px;">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å</p>
                </div>
            `;
            return;
        }
        
        attractions.sort((a, b) => (a.order || 0) - (b.order || 0));
        
        let html = '<div class="attractions-list-sortable" id="sortableAttractions">';
        
        attractions.forEach(attraction => {
            const imagesCount = attraction.images_list ? attraction.images_list.length : 0;
            const layoutText = attraction.layout === 'text_right' ? '–¢–µ–∫—Å—Ç —Å–ø—Ä–∞–≤–∞' : '–¢–µ–∫—Å—Ç —Å–ª–µ–≤–∞';
            
            html += `
                <div class="attraction-item" data-id="${attraction.id}" id="attraction-${attraction.id}">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="drag-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞">‚ãÆ‚ãÆ</div>
                        <div class="attraction-info">
                            <div class="attraction-title">${attraction.title}</div>
                            <div class="attraction-details">
                                <div class="attraction-detail">
                                    <span>üìÅ</span>
                                    <span>${attraction.folder}</span>
                                </div>
                                <div class="attraction-detail">
                                    <span>üñºÔ∏è</span>
                                    <span>${imagesCount} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</span>
                                </div>
                                <div class="attraction-detail">
                                    <span>üìê</span>
                                    <span>${layoutText}</span>
                                </div>
                                <div class="attraction-detail">
                                    <span>üî¢</span>
                                    <span>–ü–æ—Ä—è–¥–æ–∫: ${attraction.order || 1}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="attraction-actions">
                        <button class="attraction-action-btn move" onclick="moveAttraction(${attraction.id}, 'up')" title="–ü–æ–¥–Ω—è—Ç—å">
                            ‚Üë
                        </button>
                        <button class="attraction-action-btn move" onclick="moveAttraction(${attraction.id}, 'down')" title="–û–ø—É—Å—Ç–∏—Ç—å">
                            ‚Üì
                        </button>
                        <button class="attraction-action-btn edit" onclick="editAttraction(${attraction.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button class="attraction-action-btn images" onclick="manageAttractionImages(${attraction.id})" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏">
                            üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        </button>
                        <button class="attraction-action-btn delete" onclick="deleteAttraction(${attraction.id})" title="–£–¥–∞–ª–∏—Ç—å">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        
        initSortable();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    function initSortable() {
        const sortable = document.getElementById('sortableAttractions');
        if (!sortable) return;
        
        let draggedItem = null;
        const items = sortable.querySelectorAll('.attraction-item');
        
        items.forEach(item => {
            item.setAttribute('draggable', true);
            
            item.addEventListener('dragstart', function(e) {
                draggedItem = this;
                setTimeout(() => this.style.opacity = '0.4', 0);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.innerHTML);
            });
            
            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
            
            item.addEventListener('dragenter', function(e) {
                e.preventDefault();
                if (this !== draggedItem) {
                    this.style.borderTop = '2px solid #667eea';
                }
            });
            
            item.addEventListener('dragleave', function() {
                this.style.borderTop = '';
            });
            
            item.addEventListener('drop', function(e) {
                e.preventDefault();
                if (this !== draggedItem) {
                    sortable.insertBefore(draggedItem, this);
                    updateAttractionsOrder();
                }
                this.style.borderTop = '';
            });
            
            item.addEventListener('dragend', function() {
                this.style.opacity = '';
                items.forEach(item => item.style.borderTop = '');
            });
        });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞
    function updateAttractionsOrder() {
        const items = document.querySelectorAll('.attraction-item');
        const order = [];
        
        items.forEach(item => {
            const id = parseInt(item.getAttribute('data-id'));
            if (id) order.push(id);
        });
        
        fetch('/admin/attractions/order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ order: order })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('–ü–æ—Ä—è–¥–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                loadAttractions();
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        });
    }

    // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑
    function moveAttraction(id, direction) {
        const container = document.getElementById('sortableAttractions');
        const items = Array.from(container.querySelectorAll('.attraction-item'));
        const currentIndex = items.findIndex(item => parseInt(item.getAttribute('data-id')) === id);
        
        if (direction === 'up' && currentIndex > 0) {
            container.insertBefore(items[currentIndex], items[currentIndex - 1]);
            updateAttractionsOrder();
        } else if (direction === 'down' && currentIndex < items.length - 1) {
            container.insertBefore(items[currentIndex + 1], items[currentIndex]);
            updateAttractionsOrder();
        }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function showAddAttractionModal() {
        document.getElementById('attractionModalTitle').textContent = '–ù–æ–≤–∞—è –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å';
        document.getElementById('attractionId').value = '';
        document.getElementById('attractionTitle').value = '';
        document.getElementById('attractionDescription').value = '';
        document.getElementById('attractionDetailed').value = '';
        document.getElementById('attractionOrder').value = '';
        document.querySelector('input[name="layout"][value="text_left"]').checked = true;
        
        document.getElementById('attractionModal').style.display = 'block';
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function editAttraction(id) {
        fetch('/admin/attractions?format=json', {  // –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä format=json
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const attraction = data.attractions.find(a => a.id === id);
                if (attraction) {
                    document.getElementById('attractionModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏';
                    document.getElementById('attractionId').value = attraction.id;
                    document.getElementById('attractionTitle').value = attraction.title || '';
                    document.getElementById('attractionDescription').value = attraction.description || '';
                    document.getElementById('attractionDetailed').value = attraction.detailed_description || '';
                    document.getElementById('attractionOrder').value = attraction.order || '';
                    
                    const layout = attraction.layout || 'text_left';
                    document.querySelector(`input[name="layout"][value="${layout}"]`).checked = true;
                    
                    document.getElementById('attractionModal').style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
        });
    }

    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    function closeAttractionModal() {
        document.getElementById('attractionModal').style.display = 'none';
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    function saveAttraction(event) {
        event.preventDefault();
        
        const id = document.getElementById('attractionId').value;
        const title = document.getElementById('attractionTitle').value;
        const description = document.getElementById('attractionDescription').value;
        const detailed = document.getElementById('attractionDetailed').value;
        const order = parseInt(document.getElementById('attractionOrder').value) || 1;
        const layout = document.querySelector('input[name="layout"]:checked').value;
        
        const data = {
            title: title,
            description: description,
            detailed_description: detailed,
            order: order,
            layout: layout
        };
        
        const url = id ? `/admin/attractions/${id}` : '/admin/attractions';
        const method = id ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                closeAttractionModal();
                loadAttractions();
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        });
    }

    // –£–¥–∞–ª–∏—Ç—å –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    function deleteAttraction(id) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å? –í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
            return;
        }
        
        fetch(`/admin/attractions/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                loadAttractions();
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        });
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
    function manageAttractionImages(id) {
        currentAttractionId = id;
        
        fetch('/admin/attractions?format=json', {  // –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä format=json
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const attraction = data.attractions.find(a => a.id === id);
                if (attraction) {
                    document.getElementById('imagesModalTitle').textContent = `–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${attraction.title}`;
                    loadAttractionImages(id);
                    document.getElementById('imagesModal').style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
        });
    }

    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    function closeImagesModal() {
        document.getElementById('imagesModal').style.display = 'none';
        currentAttractionId = null;
        currentAttractionImages = [];
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    function loadAttractionImages(attractionId) {
        const container = document.getElementById('attractionImagesList');
        container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...</p></div>';
        
        fetch('/admin/attractions?format=json', {  // –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä format=json
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const attraction = data.attractions.find(a => a.id === attractionId);
                if (attraction && attraction.images_list) {
                    currentAttractionImages = attraction.images_list;
                    renderAttractionImages(attraction.images_list);
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;"><p>–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p></div>';
                }
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', error);
            container.innerHTML = `<div style="text-align: center; padding: 20px; color: #e53e3e;"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</p></div>`;
        });
    }

    // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function renderAttractionImages(images) {
        const container = document.getElementById('attractionImagesList');
        
        if (!images || images.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;"><p>–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p></div>';
            return;
        }
        
        let html = '<div class="images-grid">';
        
        images.forEach((image) => {
            const imagePath = `/static/images/attraction-block/block-${currentAttractionId}/${image}`;
            
            html += `
                <div class="image-item">
                    <div class="image-preview" style="background-image: url('${imagePath}')"></div>
                    <div class="image-info">
                        <div class="image-filename" title="${image}">${image}</div>
                        <div class="image-actions">
                            <button class="image-action-btn delete" onclick="deleteAttractionImage('${image}')">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    function handleAttractionImageUpload() {
        const files = document.getElementById('attractionImageUpload').files;
        if (!files.length || !currentAttractionId) return;
        
        const progressBar = document.getElementById('attractionUploadBar');
        const progressContainer = document.getElementById('attractionUploadProgress');
        
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        
        let uploadedCount = 0;
        const totalFiles = files.length;
        
        Array.from(files).forEach((file, index) => {
            const formData = new FormData();
            formData.append('image', file);
            
            fetch(`/admin/attractions/${currentAttractionId}/images`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                uploadedCount++;
                progressBar.style.width = `${(uploadedCount / totalFiles) * 100}%`;
                
                if (uploadedCount === totalFiles) {
                    showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${uploadedCount} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`, 'success');
                    
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 1000);
                    
                    loadAttractionImages(currentAttractionId);
                    document.getElementById('attractionImageUpload').value = '';
                }
            })
            .catch(error => {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
                progressContainer.style.display = 'none';
            });
        });
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    function deleteAttractionImage(filename) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ?')) return;
        
        fetch(`/admin/attractions/${currentAttractionId}/images/${encodeURIComponent(filename)}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
                loadAttractionImages(currentAttractionId);
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadAttractions();
        
        const textareas = document.querySelectorAll('#attractionDescription, #attractionDetailed');
        textareas.forEach(textarea => {
            textarea.addEventListener('input', function() {
                const counter = this.parentElement.querySelector('.char-counter');
                if (counter) {
                    counter.textContent = `${this.value.length}/${this.getAttribute('maxlength') || 1000}`;
                }
            });
        });
    });
</script>
{% endblock %}

{% block content %}
<!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è–º–∏ -->
<section class="admin-section attractions-admin-section">
    <div class="section-header">
        <h2><i>üèûÔ∏è</i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è–º–∏</h2>
        <button class="save-btn" onclick="showAddAttractionModal()">
            <i>+</i> –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        </button>
    </div>
    
    <div class="attractions-list-container">
        <div class="attractions-list" id="attractionsList">
            <div style="text-align: center; padding: 40px;">
                <div class="loading"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π...</p>
            </div>
        </div>
    </div>
</section>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="modal" id="attractionModal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <button class="close" onclick="closeAttractionModal()">√ó</button>
        <h2 id="attractionModalTitle">–ù–æ–≤–∞—è –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h2>
        
        <form id="attractionForm" onsubmit="saveAttraction(event)">
            <input type="hidden" id="attractionId" value="">
            
            <div class="form-group">
                <label for="attractionTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
                <input type="text" id="attractionTitle" required placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫">
            </div>
            
            <div class="form-group">
                <label for="attractionDescription">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ *</label>
                <textarea id="attractionDescription" rows="4" required placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ)"></textarea>
                <div class="char-counter">0/1000</div>
            </div>
            
            <div class="form-group">
                <label for="attractionDetailed">–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="attractionDetailed" rows="6" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ø–æ–ø–∞–ø–µ)"></textarea>
                <div class="char-counter">0/2000</div>
            </div>
            
            <div class="form-group">
                <label>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="layout" value="text_left" checked>
                        <span>–¢–µ–∫—Å—Ç —Å–ª–µ–≤–∞, —Ñ–æ—Ç–æ —Å–ø—Ä–∞–≤–∞</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="layout" value="text_right">
                        <span>–¢–µ–∫—Å—Ç —Å–ø—Ä–∞–≤–∞, —Ñ–æ—Ç–æ —Å–ª–µ–≤–∞</span>
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label>–ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                <input type="number" id="attractionOrder" min="1" value="1">
            </div>
            
            <div class="form-actions">
                <button type="submit" class="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="cancel-btn" onclick="closeAttractionModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ -->
<div class="modal" id="imagesModal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
        <button class="close" onclick="closeImagesModal()">√ó</button>
        <h2 id="imagesModalTitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏</h2>
        
        <div class="images-management">
            <div class="upload-area" style="margin-bottom: 20px;">
                <input type="file" id="attractionImageUpload" accept=".jpg,.jpeg,.png,.gif,.webp" multiple 
                    style="display: none;" onchange="handleAttractionImageUpload()">
                <button onclick="document.getElementById('attractionImageUpload').click()" 
                        class="save-btn" style="background: #4299e1;">
                    üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                </button>
                <p style="font-size: 12px; color: #718096; margin-top: 10px;">
                    –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 16MB
                </p>
            </div>
            
            <div id="attractionUploadProgress" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="loading"></div>
                    <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div style="width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; margin-top: 10px;">
                    <div id="attractionUploadBar" style="width: 0%; height: 100%; background: #48bb78; border-radius: 2px; transition: width 0.3s;"></div>
                </div>
            </div>
            
            <div class="images-list" id="attractionImagesList">
                <div style="text-align: center; padding: 20px;">
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...</p>
                </div>
            </div>
        </div>
        
        <div class="modal-actions">
            <button type="button" class="cancel-btn" onclick="closeImagesModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}